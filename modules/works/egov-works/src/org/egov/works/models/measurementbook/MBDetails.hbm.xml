<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
	<!-- Generated on 8th dec 09 -->
<hibernate-mapping>
	<class name="org.egov.works.models.measurementbook.MBDetails" table="EGW_MB_DETAILS">
		<id name="id" type="long">
			<column name="ID" />
			<generator class="sequence">
				<param name="sequence">EGW_MB_DETAILS_SEQ</param>
			</generator>
		</id>
		<many-to-one name="mbHeader"
			class="org.egov.works.models.measurementbook.MBHeader" column="MBHEADER_ID"
			not-null="true" fetch="select" insert="false" update="false"/>
		<many-to-one name="workOrderActivity"
			class="org.egov.works.models.workorder.WorkOrderActivity" column="WO_ACTIVITY_ID"
			not-null="true" fetch="select" />

		<property name="quantity" type="double">
			<column name="QUANTITY" precision="20" not-null="true"/>
		</property>
		
		<property name="remark" type="string">
			<column name="REMARK" length="400" />
		</property>
         
         <property name="mbdetailsDate" type="date">
			<column name="MBDETAIL_DATE"/>
		</property>
		
		<property name="OrderNumber" type="string">
			<column name="ORDER_NUMER"/>
		</property>

		<many-to-one name="createdBy" class="org.egov.lib.rjbac.user.UserImpl" column="CREATED_BY" not-null="true" fetch="select" />
		<many-to-one name="modifiedBy" class="org.egov.lib.rjbac.user.UserImpl" column="MODIFIED_BY" not-null="true" fetch="select"/>
		<property name="createdDate" column="CREATED_DATE" type="timestamp" not-null="true"/>	
		<property name="modifiedDate" column="MODIFIED_DATE" type="timestamp" not-null="true"/>
		
		<list name="mbMeasurementSheetList" inverse="false" cascade="all,delete-orphan" >
			<key column="MBDETAILS_ID" not-null="true" />
			<list-index column="MBMEASUREMENTSHEET_INDEX" />
			<one-to-many class="org.egov.works.models.measurementbook.MBMeasurementSheet" />
		</list>
		
		<property name="partRate" type="double">
			<column name="PART_RATE" precision="20" />
		</property>
		
		<property name="reducedRate" type="double">
			<column name="REDUCED_RATE" precision="20" />
		</property>
		
	</class>	
	<query name="prevCumulativeQuantity">
		<![CDATA[
     	select sum(mbd.quantity) from MBDetails mbd where (mbd.mbHeader.createdDate 
     	< (select createdDate from MBHeader where id = ?) or (select count(*) from MBHeader where id = ?) = 0 )
     	and mbd.mbHeader.state.previous.value != 'CANCELLED' 
     	group by mbd.workOrderActivity,mbd.workOrderActivity.activity having (mbd.workOrderActivity.id = ? or mbd.workOrderActivity.activity.id = ? ) 
    ]]>
	</query>
	
	<query name="prevCumulativeQuantityForRE">
		<![CDATA[
     	select sum(mbd.quantity) from MBDetails mbd where (mbd.mbHeader.createdDate 
     	< (select createdDate from MBHeader where id = ?) or (select count(*) from MBHeader where id = ?) = 0 )
     	and mbd.mbHeader.state.previous.value != 'CANCELLED' 
     	group by mbd.workOrderActivity.activity.parent having ((mbd.workOrderActivity.activity.parent is not null and mbd.workOrderActivity.activity.parent.id = ?)) 
    ]]>
	</query>
	
	<query name="totalEstimatedQuantity">
		<![CDATA[
           select sum(woa.approvedQuantity) from WorkOrderActivity woa 
            group by woa,woa.activity having (id = ? or activity.id = ?)
   		]]>  
	</query>
	
	<query name="totalEstimatedQuantityInView">
		<![CDATA[            
             select sum(woa.approvedQuantity) from WorkOrderActivity woa where woa.workOrderEstimate.id in(select mbh.workOrderEstimate.id from MBHeader mbh where mbh.state.previous.value != 'CANCELLED'
            and mbh.createdDate
            < (select createdDate from MBHeader where id = ?) or (select count(*) from MBHeader where id = ?) = 0 )
            group by woa,woa.activity having (id = ? or activity.id = ?)
   		]]>  
	</query>
	
	<query name="totalEstimatedQuantityForRE"> 
		<![CDATA[
     	select sum(woa.approvedQuantity) from WorkOrderActivity woa where woa.activity.abstractEstimate.egwStatus.code != 'CANCELLED' 
     	group by woa.activity.parent having (woa.activity.parent is not null and woa.activity.parent.id = ? ) 
    ]]>
	</query>
	
	<query name="totalEstimatedQuantityForREinView">
		<![CDATA[
     	select sum(woa.approvedQuantity) from WorkOrderActivity woa where id in(select mbd.workOrderActivity.id from MBDetails mbd where mbd.mbHeader.state.previous.value != 'CANCELLED'     	  
     	and mbd.mbHeader.createdDate < (select createdDate from MBHeader where id = ?) or (select count(*) from MBHeader where id = ?) = 0 ) 
     	and woa.activity.abstractEstimate.egwStatus.code != 'CANCELLED' 
     	group by woa.activity.parent having (woa.activity.parent is not null and woa.activity.parent.id = ? ) 
    ]]>
	</query>
		
	<query name="totalEstimatedQuantityInRE">
		<![CDATA[            
            select sum(woa.approvedQuantity) from WorkOrderActivity woa where woa.activity.abstractEstimate.egwStatus.code != 'CANCELLED' and 
            woa.activity.abstractEstimate.id != ? 
            group by woa,woa.activity having (id = ? or activity.id = ?)
   		]]>  
	</query>
	
	<query name="totalEstimatedQuantityForREinRE">
		<![CDATA[
     	select sum(woa.approvedQuantity) from WorkOrderActivity woa where woa.activity.abstractEstimate.egwStatus.code != 'CANCELLED' 
     	and woa.activity.abstractEstimate.id != ?
     	group by woa.activity.parent having (woa.activity.parent is not null and woa.activity.parent.id = ? ) 
    ]]> 
	</query>
		
	<query name="totalApprovedMBAmount">
		<![CDATA[
     	select sum(mbd.quantity*mbd.workOrderActivity.approvedRate) from MBDetails mbd
     	 where mbd.mbHeader.state.previous.value = 'APPROVED' 
     	and mbd.workOrderActivity.workOrderEstimate.workOrder.id = ? and mbd.mbHeader.workOrderEstimate.id = ? and trunc(mbd.mbHeader.state.createdDate) <= ? and mbd.mbHeader.mbBills is null
    ]]>
	</query>
	<query name="totalApprovedMBAmountForCancelledBill">
		<![CDATA[
     	select sum(mbd.quantity*mbd.workOrderActivity.approvedRate) from MBDetails mbd left join mbd.mbHeader.mbBills bills
     	 where mbd.mbHeader.state.previous.value = 'APPROVED' 
     	and mbd.workOrderActivity.workOrderEstimate.workOrder.id = ? and mbd.mbHeader.workOrderEstimate.id = ? and trunc(mbd.mbHeader.state.createdDate) <= ? 
     	and bills is not null and bills.egBillregister.billstatus = 'CANCELLED'
    ]]>
	</query>
	<query name="getUtlizedAmountForUnArrovedBill">
		<![CDATA[
     	select sum(reg.egBillregister.passedamount) from MBHeader mbh join mbh.mbBills as reg where 
     	reg.egBillregister.state.value not in ('CANCELLED') and mbh.workOrder.id = ? and trunc(reg.egBillregister.billdate) <= ?
     	and reg.egBillregister.egBillregistermis.voucherHeader is null
    ]]>
	</query>
	
	<query name="gettotalApprovedMBs">
		<![CDATA[
     	 select distinct mbd from MBDetails mbd 
     	 where mbd.mbHeader.state.previous.value = 'APPROVED' 
     	 and mbd.workOrderActivity.workOrderEstimate.workOrder.id = ? and mbd.mbHeader.workOrderEstimate.id = ? and trunc(mbd.mbHeader.state.createdDate) <= ?
    ]]>
	</query>
	<query name="gettotalApprovedMBDsFromOldRE">
		<![CDATA[
     	 select distinct  mbd from  MBDetails mbd
     	 where mbd.mbHeader.state.previous.value = 'APPROVED' and mbd.workOrderActivity.workOrderEstimate.estimate.parent.id = ?  
     	 and mbd.mbHeader.revisionEstimate is null  and trunc(mbd.mbHeader.state.createdDate) <= ? 
    ]]>
	</query>
	<query name="gettotalREApprovedMBDs">
		<![CDATA[
     	 select distinct  mbd from  MBDetails mbd 
     	 where mbd.mbHeader.state.previous.value = 'APPROVED' and mbd.workOrderActivity.workOrderEstimate.estimate.parent.id = ?  
     	 and mbd.mbHeader.revisionEstimate is not null and mbd.mbHeader.revisionEstimate.egwStatus.code='APPROVED'
     	and mbd.mbHeader.revisionEstimate.parent.id = ? and trunc(mbd.mbHeader.state.createdDate) <= ? 
    ]]>
	</query>
	<query name="gettotalREApprovedMBDsForCancelledBill">
		<![CDATA[
     	 select mbd from MBDetails mbd left join mbd.mbHeader mbh left join mbh.mbBills mbBills
     	 where mbd.mbHeader.state.previous.value = 'APPROVED' and mbd.workOrderActivity.workOrderEstimate.estimate.parent.id = ?  
     	and mbd.mbHeader.revisionEstimate is not null and mbd.mbHeader.revisionEstimate.egwStatus.code='APPROVED' 
     	and mbd.mbHeader.revisionEstimate.parent.id = ? and trunc(mbd.mbHeader.state.createdDate) <= ? 
     	and mbBills is not null and mbBills.egBillregister.billstatus = 'CANCELLED'
    ]]>
	</query>
	<query name="gettotalApprovedMBsForCancelledBill">
		<![CDATA[
     	 select mbd from MBDetails mbd left join mbd.mbHeader.mbBills mbBills
     	 where mbd.mbHeader.state.previous.value = 'APPROVED' 
     	and mbd.workOrderActivity.workOrderEstimate.workOrder.id = ? and mbd.mbHeader.workOrderEstimate.id = ? and trunc(mbd.mbHeader.state.createdDate) <= ? 
     	and mbBills is not null and mbBills.egBillregister.billstatus = 'CANCELLED'
    ]]>
	</query>
	<query name="getMBAmountForBill">
		<![CDATA[
     	 select mbd from MBDetails mbd left join mbd.mbHeader.mbBills mbBills
     	 where mbd.mbHeader.state.previous.value = 'APPROVED'  
     	and mbBills.egBillregister.id = ?
    ]]>
	</query>
</hibernate-mapping>
