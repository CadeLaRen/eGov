<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
<class name="org.egov.works.models.masters.ScheduleOfRate" table="EGW_SCHEDULEOFRATE">
		<id
			name="id"
			column="ID"
			type="long"
			unsaved-value="null">
			<generator class="native">
				<param name="sequence">EGW_SCHEDULEOFRATE_SEQ</param>
			</generator>
		</id>		
		<many-to-one name="createdBy" class="org.egov.lib.rjbac.user.UserImpl" column="CREATED_BY" fetch="select" />
		<many-to-one name="modifiedBy" class="org.egov.lib.rjbac.user.UserImpl" column="MODIFIED_BY" fetch="select"/>
		<property name="createdDate" column="CREATED_DATE" type="timestamp" />
		<property name="modifiedDate" column="MODIFIED_DATE" type="timestamp" />
   <property unique="true"
	    name="code"
	    column="CODE"
	    type="string"
    />
  
   <property
	    name="description"
	    column="DESCRIPTION"
	    type="string"
    />   
   
    <many-to-one name="category" not-null="true"/>
    <many-to-one name="type"/>
    <many-to-one name="uom" not-null="true"/>
    <list name="rates" cascade="all,delete-orphan">
    	<key column="SCHEDULEOFRATE_ID"  not-null="true" />
    	<list-index column="MY_SOR_INDEX"/>
    	<one-to-many class="org.egov.works.models.masters.Rate" />	
    </list>
      <!--  added by prashanth 2nd october  --> 
    <list name="marketRates" cascade="all,delete-orphan">
    	<key column="SCHEDULEOFRATE_ID"  not-null="true" />
    	<list-index column="MARKET_SOR_INDEX"/>
    	<one-to-many class="org.egov.works.models.masters.MarketRate" />	
    </list>
</class>
<query name="SCHEDULEOFRATES_BY_IDS">
		<![CDATA[
     	from org.egov.works.models.masters.ScheduleOfRate where id in(:param_0)   
    ]]>
</query>

<query name="SCHEDULEOFRATES_SEARCH">
		<![CDATA[
     	from org.egov.works.models.masters.ScheduleOfRate as sch inner join fetch sch.rates as rates where (sch.code like concat ('%', ?, '%')
     	 or sch.description like concat ('%', ?, '%')) and sch.category.id=?  and  ((? between rates.validity.startDate and rates.validity.endDate ) 
         or (rates.validity.startDate<=? and rates.validity.endDate is null))   
    ]]>
</query>

<query name="SCHEDULEOFRATES_SEARCH_ESTIMATETEMPLATE">
		<![CDATA[
     	from org.egov.works.models.masters.ScheduleOfRate as sch where (sch.code like concat ('%', ?, '%')
     	 or sch.description like concat ('%', ?, '%')) and sch.category.id=?    
    ]]>
</query>
 
<query name="SCHEDULEOFRATES_SEARCH_REVISIONESTIMATE">
		<![CDATA[
     	from org.egov.works.models.masters.ScheduleOfRate as sch inner join fetch sch.rates as rates where (sch.code like concat ('%', ?, '%')
     	 or sch.description like concat ('%', ?, '%')) and sch.category.id=?  and  ((? between rates.validity.startDate and rates.validity.endDate ) 
         or (rates.validity.startDate<=? and rates.validity.endDate is null)) and sch.id not in(select act.schedule.id from Activity act
         where (act.abstractEstimate.id=? and act.schedule is not null)) 
         and sch.id not in(select act2.schedule.id from Activity act2
         where ((act2.abstractEstimate.parent is not null and act2.abstractEstimate.parent.id=? and act2.abstractEstimate.parent.egwStatus is not null and act2.abstractEstimate.parent.egwStatus.code!='CANCELLED')) and act2.schedule is not null)  
    ]]>
</query> 

</hibernate-mapping>